<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <title>Wealthica Example Add-on</title>
  <link rel="stylesheet" type="text/css" media="all" href="https://luke-s-alexander.github.io/luke-wealthica/lib/app-wealthica.css">
  <style>
    body { margin: 0; padding: 0; }
  </style>
  <script type="text/javascript" src="https://wealthica.github.io/wealthica.js/dist/addon.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
  <script type="text/javascript" src="./dist/main.js"></script>
</head>
<body>
  <div class="no-data__content no-data__content--documents">
    <p>Click the button below to download current positions data.</p>
    <a class="site-button site-button--normal btn-upload-document" id="getPositions">
      <span>Download Positions</span>
    </a>
    <a class="site-button site-button--normal btn-upload-document" id="getTransactions">
      <span>Download Transactions</span>
    </a>
  </div>
  <pre id="result"></pre>

<!--   <script type="text/javascript">
    var addon, addonOptions;

    $(function () {
      addon = new Addon();

      addon.on('init', function (options) {
        // Dashboard is ready and is signaling to the add-on that it should
        // render using the passed in options (filters, language, etc.)
        addonOptions = options;
        $('button').removeAttr('disabled');
        showAddonData(addonOptions.data, true);
      }).on('update', function (options) {
        // Filters have been updated and Dashboard is passing in updated options
        addonOptions = _.extend(addonOptions, options);
        showAddonData(addonOptions.data);
      });

      $('#addTransaction').on('click', function () {
        $(this).attr('disabled', 'disabled');

        addon.addTransaction({
          description: "New transaction from Example Add-on"
        }).then(function (transaction) {
          $('#result').html('New transaction:<br><code>' + JSON.stringify(transaction) + '</code>');
        }).catch(function (err) {
          $('#result').html('Error:<br><code>' + err + '</code>');
        }).finally(function () {
          $('#addTransaction').removeAttr('disabled');
        });
      });

      $('#getTransactions').on('click', function () {
        $(this).attr('disabled', 'disabled');

        addon.api.getTransactions(getQueryFromOptions(addonOptions)).then(function (response) {
          $('#result').html('List Transactions Result:<br><code>' + JSON.stringify(response) + '</code>');
        }).catch(function (err) {
          $('#result').html('Error:<br><code>' + err + '</code>');
        }).finally(function () {
          $('#getTransactions').removeAttr('disabled');
        });
      });

      $('#getPositions').on('click', function () {
        $(this).attr('disabled', 'disabled');

        addon.api.getPositions(getQueryFromOptions(addonOptions)).then(function (response) {
          $('#result').html('List Positions Result:<br><code>' + JSON.stringify(response) + '</code>');
          exportPositionsToCsvFile(response);
        }).catch(function (err) {
          $('#result').html('Error:<br><code>' + err + '</code>');
        }).finally(function () {
          $('#getPositions').removeAttr('disabled');
        });
      });
      
      $('#getInstitutions').on('click', function () {
        $(this).attr('disabled', 'disabled');
        
        addon.api.getInstitutions({ date: '2018-01-01' }).then(function (response) {
          $('#result').html('List Positions Result:<br><code>' + JSON.stringify(response) + '</code>');
        }).catch(function (err) {
           $('#result').html('Error:<br><code>' + err + '</code>'); 
        }).finally(function () {
          $('#getPositions').removeAttr('disabled');
        });
      });

      $('#getInstitutionAssests').on('click', function () {
        $(this).attr('disabled', 'disabled');
        
        addon.request({
          method: 'GET',
          endpoint: 'positions',
          query: {
            institutions: '5d3f063d3a9546000409532f',
            assets: true,
          }
        }).then(function (response) {
          $('#result').html('List Assets Result:<br><code>' + JSON.stringify(response) + '</code>');
        }).catch(function (err) {
           $('#result').html('Error:<br><code>' + err + '</code>'); 
        }).finally(function () {
          $('#getInstitutionAssests').removeAttr('disabled');
        });
      });

      $('#saveData').on('click', function () {
        $(this).attr('disabled', 'disabled');
        var newData = $('#data').val();

        // Try parsing textarea value to a JSON object before passing to addon.saveData(data)
        try { newData = JSON.parse(newData) }
        catch (e) {
          $('#result').html('Error:<br><code>Data must be JSON</code>');
          $('#saveData').removeAttr('disabled');
          return;
        }

        addon.saveData(newData).catch(function (err) {
          $('#result').html('Error:<br><code>' + err + '</code>');
        }).finally(function () {
          $('#saveData').removeAttr('disabled');
        });
      });

      // Show addon data in result box and optionally update the text input.
      function showAddonData(data, updateInput) {
        $('#result').html('Addon data:<br><code>' + JSON.stringify(data) + '</code>');
        if (updateInput && data) {
          $('#data').val(JSON.stringify(data));
        }
      }

      // Compose a query object from the addon options to pass to the API calls.
      function getQueryFromOptions (options) {
        return {
          from: options.dateRangeFilter && options.dateRangeFilter[0],
          to: options.dateRangeFilter && options.dateRangeFilter[1],
          groups: options.groupsFilter,
          institutions: options.institutionsFilter,
          investments: options.investmentsFilter === 'all' ? null: options.investmentsFilter,
        }
      }

      // Parse JSON object into CSV string
      function parsePositionsToCsvFile(jsonData) {
        if(jsonData.length == 0) {
          return '';
        }
        // Create array of column headers
        let keys = [
            'category', 
            'class', 
            'symbol', 
            'alias', 
            'investment', 
            'quantity', 
            'book_value', 
            'market_value', 
            'currency', 
            'gain_percent', 
            'gain_amount'
        ];
        // Set formats
        let columnDelimiter = ',';
        let lineDelimiter = '\n';
        // Build header
        let csvColumnHeader = keys.join(columnDelimiter);
        let csvStr = csvColumnHeader + lineDelimiter;
        var shared = []
        // Loop through position results
        jsonData.forEach(item => {
          // Don't print any data at the position level, but capture shared data
          shared = [ 
              item.category, 
              item.class, 
              item.security.symbol, 
              item.security.aliases[0] 
          ];
          // Loop through investments for each position
          item.investments.forEach(element => {
            var investment_data = [
                element.investment, 
                element.quantity, 
                element.book_value, 
                element.market_value, 
                element.currency, 
                element.gain_percent, 
                element.gain_amount
            ];
            // Add investment data to shared position data
            investment_data = shared.concat(investment_data);
            // Loop through investment data and create csv row
            investment_data.forEach((entry, index) => {
                if( (index > 0) && (index < investment_data.length) ) {
                    csvStr += columnDelimiter;
                }
                csvStr += entry;
            });
            csvStr += lineDelimiter
          });
        });
       return encodeURIComponent(csvStr);
      }


      // Parse JSON object into CSV string
      function exportPositionsToCsvFile(jsonData) {
          let csvStr = parsePositionsToCsvFile(jsonData);
          let dataUri = 'data:text/csv;charset=utf-8,'+ csvStr;
          var today = new Date();
          var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
          var time = today.getHours().toString() + today.getMinutes() + today.getSeconds();

          let exportFileDefaultName = 'positions_' + date + time + '.csv';

          let linkElement = document.createElement('a');
          linkElement.setAttribute('href', dataUri);
          linkElement.setAttribute('download', exportFileDefaultName);
          linkElement.click();
      }

    });
  </script> -->

</body>
</html>
